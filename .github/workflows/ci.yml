name: SnappiPay CI/CD Pipeline

on:
  push:
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job for Aptos Move contracts
  aptos:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'RampAptos/') || github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install Aptos CLI
      run: |
        curl -fsSL "https://aptos.dev/scripts/install_cli.py" | python3
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    
    - name: Build and Test RampAptos
      run: |
        cd RampAptos
        aptos move compile
        aptos move test

  # Job for Solidity/Foundry contracts
  foundry:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'RampSol/') || github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Foundry
      uses: foundry-rs/foundry-toolchain@v1

    - name: Build and Test RampSol
      run: |
        cd RampSol
        forge install
        forge build
        forge test

  # Job for Supra Move contracts
  supra:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'RampSup/') || github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install Supra CLI
      run: |
        # Create supra directory if it doesn't exist
        mkdir -p supra
        cd supra
        
        # Download and start Supra CLI container
        curl https://raw.githubusercontent.com/supra-labs/supra-dev-hub/refs/heads/main/Scripts/cli/compose.yaml | docker compose -f - up -d
        
        # Wait for container to be ready and verify it's running
        sleep 10
        docker ps --all
        
        # Test if container is responsive
        timeout 30 docker exec supra_cli supra --help || {
          echo "Container not ready, checking logs..."
          docker logs supra_cli
          exit 1
        }
        
        cd ..
    
    - name: Build and Test RampSup
      run: |
        # Copy RampSup to supra directory for container access
        cp -r RampSup supra/
        
        # Check container setup and find supra executable
        echo "Checking Supra CLI container setup..."
        docker exec supra_cli ls -la /usr/local/bin/ || true
        docker exec supra_cli which supra || docker exec supra_cli find / -name "supra" 2>/dev/null | head -5 || true
        
        # Determine the correct supra executable path
        if docker exec supra_cli test -f /usr/local/bin/supra; then
          SUPRA_CMD="/usr/local/bin/supra"
        elif docker exec supra_cli test -f /opt/supra/bin/supra; then
          SUPRA_CMD="/opt/supra/bin/supra"
        elif docker exec supra_cli test -f /supra/supra; then
          SUPRA_CMD="/supra/supra"
        else
          echo "ERROR: Supra executable not found in container"
          exit 1
        fi
        
        echo "Using Supra CLI at: $SUPRA_CMD"
        
        # Run supra commands with the correct path
        docker exec -w /supra/RampSup supra_cli $SUPRA_CMD move tool compile
        docker exec -w /supra/RampSup supra_cli $SUPRA_CMD move tool test

  # Job for Rust/Solana contracts
  solana:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'ramp_solana/') || github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          ramp_solana/target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Build and Test ramp_solana
      run: |
        cd ramp_solana
        cargo build
        cargo test

  # Job for Cairo/StarkNet contracts
  starknet:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'ramp_stark/') || github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
    - uses: software-mansion/setup-scarb@v1
    - uses: foundry-rs/setup-snfoundry@v3
    - name: Build and Test ramp_stark
      run: |
        cd ramp_stark
        scarb build
        snforge test

  # Job to run complete workflow
  complete-workflow:
    runs-on: ubuntu-latest
    needs: [aptos, foundry, supra, solana, starknet]
    if: always()
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install all dependencies
      shell: bash
      run: |
        # Install Rust
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source ~/.cargo/env
        
        # Install Foundry
        curl -L https://foundry.paradigm.xyz | bash
        export PATH="$HOME/.foundry/bin:$PATH"
        source ~/.bashrc || true
        foundryup
        
        # Install Aptos CLI
        curl -fsSL "https://aptos.dev/scripts/install_cli.py" | python3
        
        # Install Scarb with explicit shell handling
        export SHELL=/bin/bash
        curl --proto '=https' --tlsv1.2 -sSf https://docs.swmansion.com/scarb/install.sh | sh
        
        # Install StarkNet Foundry (snforge)
        curl -L https://raw.githubusercontent.com/foundry-rs/starknet-foundry/master/scripts/install.sh | sh
        export PATH="$HOME/.local/bin:$PATH"
        
        # Verify installations and add to PATH
        ls -la $HOME/.local/bin/ || true
        ls -la $HOME/.cargo/bin/ || true
        ls -la $HOME/.foundry/bin/ || true
        
        # Add to PATH for subsequent steps
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        echo "$HOME/.foundry/bin" >> $GITHUB_PATH
        
        # Test that tools are available
        export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$HOME/.foundry/bin:$PATH"
        which scarb || echo "Scarb not found in PATH"
        which snforge || echo "snforge not found in PATH"
        which aptos || echo "Aptos not found in PATH"
        which forge || echo "Forge not found in PATH"
        which cargo || echo "Cargo not found in PATH"

    - name: Run Complete Workflow
      run: |
        chmod +x build_all.sh
        ./build_all.sh